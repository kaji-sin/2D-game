<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üí® „Åä„Å™„Çâ„Éï„Çß„É©„Éº„É™„É¨„Éº„Çµ„Éº„Ç∫</title>
  <style>
    html, body { height: 100%; margin: 0; background: #0b1020; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; }
    #wrap { display: grid; place-items: center; height: 100%; }
    #hud { position: fixed; top: 8px; left: 12px; font-weight: 600; text-shadow: 0 1px 0 rgba(0,0,0,.4); }
    #tip { position: fixed; right: 12px; bottom: 8px; opacity: .8; font-size: 14px; }
    #stage { position: fixed; top: 8px; right: 12px; font-weight: 700; }
    canvas { background: #87ceeb; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.3); }
    .btn { position: fixed; left: 50%; transform: translateX(-50%); bottom: 14px; background: #c00; border-radius: 999px; padding: 10px 16px; cursor: pointer; user-select: none; font-weight: 700; display:none; color:#fff; }
  </style>
</head>
<body>
  <audio id="bgm" preload="auto" loop></audio>
  <div id="wrap">
    <canvas id="cv" width="960" height="600"></canvas>
    <div id="restart" class="btn">R „Åß„É™„Çπ„Çø„Éº„Éà / „ÇØ„É™„ÉÉ„ÇØ„Åß„ÇÇOK</div>
  </div>
  <div id="hud"></div>
  <div id="stage"></div>
  <div id="tip">Space: Â∞ÑÊíÉ / ‚Üë: „Åä„Å™„Çâ„Éñ„Éº„Çπ„Éà / ‚Üê‚Üí: ‰∏ä‰∏ãÁßªÂãï / R: „É™„Çπ„Çø„Éº„Éà / Esc: ÂÅúÊ≠¢</div>

  <script>
  (() => {
    const W = 960, H = 600;
    const cv = document.getElementById('cv');
    const ctx = cv.getContext('2d');
    const hud = document.getElementById('hud');
    const stageEl = document.getElementById('stage');
    const btnRestart = document.getElementById('restart');
    const rand = (a,b)=>Math.random()*(b-a)+a;

    const STAGES = [
      { name: 'City', bg: '#87ceeb', enemySpeed: 4.5, spawn: 42, gate: 120 },
      { name: 'Desert', bg: '#f4deb3', enemySpeed: 5.8, spawn: 34, gate: 280 },
      { name: 'Space', bg: '#080820', enemySpeed: 7.2, spawn: 26, gate: 9e9 },
    ];
    let stageIndex = 0;

    const keys = {};
    window.addEventListener('keydown', e => { keys[e.key] = true; });
    window.addEventListener('keyup', e => { keys[e.key] = false; });

    class Particle {
      constructor(x,y){
        this.x=x; this.y=y; this.vx = -rand(2.0,4.2); this.vy = rand(-1.2,1.2);
        this.life = Math.floor(rand(20,34)); this.size = Math.floor(rand(5,12));
        const r = Math.floor(rand(200,255)), g = Math.floor(rand(0,60)), b = Math.floor(rand(0,10));
        this.color = `rgb(${r},${g},${b})`;
      }
      update(){ this.x+=this.vx; this.y+=this.vy; this.life--; return this.life>0; }
      draw(){ ctx.beginPath(); ctx.fillStyle=this.color; ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); }
    }

    class Player {
      constructor(){ this.w=90; this.h=40; this.x=80; this.y=H/2; this.boost=0; this.maxBoost=9.2; this.health=5; this.weapon=1; this.shootCd=0; }
      rect(){ return {x:this.x,y:this.y,w:this.w,h:this.h}; }
      update(){
        if(keys['ArrowUp']){ this.boost+=0.5; for(let i=0;i<2;i++) particles.push(new Particle(this.x-8, this.y+this.h/2)); }
        this.boost*=0.94; if(this.boost>this.maxBoost) this.boost=this.maxBoost; this.x+=this.boost;
        if(keys['ArrowLeft']) this.y-=6; if(keys['ArrowRight']) this.y+=6;
        this.x=Math.max(20,Math.min(this.x, W-this.w-20)); this.y=Math.max(20,Math.min(this.y, H-this.h-20));
        if(this.shootCd>0) this.shootCd--; }
      draw(){
        ctx.save(); ctx.translate(this.x,this.y);
        ctx.fillStyle = 'red'; ctx.beginPath();
        ctx.moveTo(0,20); ctx.quadraticCurveTo(45,-10,90,15); ctx.quadraticCurveTo(92,40,0,30); ctx.closePath(); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.fillRect(25,10,15,8);
        ctx.fillStyle = '#000'; ctx.fillRect(10,28,20,8); ctx.fillRect(60,28,20,8);
        ctx.restore(); }
    }

    class Bullet { constructor(x,y,vx=13,vy=0){ this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.r=5; }
      update(){ this.x+=this.vx; this.y+=this.vy; return this.x<=W; }
      draw(){ ctx.beginPath(); ctx.fillStyle='#fff'; ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fill(); }
    }

    class Enemy { constructor(speed){ this.w=56; this.h=36; this.x=W+rand(0,60); this.y=rand(50,H-50); this.speed=speed; this.hp=2; }
      rect(){ return {x:this.x,y:this.y,w:this.w,h:this.h}; }
      update(playerY){ this.x-=this.speed; const dy=playerY-this.y; this.y+=Math.max(-3, Math.min(3, dy*0.03)); return this.x>-this.w; }
      draw(){ ctx.fillStyle='gray'; ctx.fillRect(this.x,this.y,this.w,this.h); }
    }

    function collide(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
    function collideCircleRect(cx,cy,cr, r){ const nx=Math.max(r.x,Math.min(cx,r.x+r.w)); const ny=Math.max(r.y,Math.min(cy,r.y+r.h)); const dx=cx-nx, dy=cy-ny; return dx*dx+dy*dy <= cr*cr; }

    let player, bullets, enemies, particles, score, spawnT, running=true, gameOver=false;
    function reset(){ player=new Player(); bullets=[]; enemies=[]; particles=[]; score=0; spawnT=0; stageIndex=0; gameOver=false; running=true; }
    reset();

    function tryShoot(){ if(player.shootCd>0) return; const px=player.x+player.w, py=player.y+player.h/2; bullets.push(new Bullet(px,py)); player.shootCd=8; }

    let last=0; function loop(t){ last=t; if(!running){ requestAnimationFrame(loop); return; }
      const st=STAGES[stageIndex]; cv.style.background=st.bg;

      if(!gameOver){ if(keys[' ']) tryShoot(); player.update(); bullets=bullets.filter(b=>b.update()); spawnT++; if(spawnT>st.spawn){ enemies.push(new Enemy(st.enemySpeed)); spawnT=0; }
        enemies=enemies.filter(e=>e.update(player.y)); particles=particles.filter(p=>p.update()); bullets=bullets.filter(b=>{ let hit=false; for(let i=0;i<enemies.length;i++){ if(collideCircleRect(b.x,b.y,b.r,enemies[i].rect())){ enemies[i].hp--; hit=true; if(enemies[i].hp<=0){ score+=10; enemies.splice(i,1); } break;} } return !hit; }); const pr=player.rect(); for(let i=enemies.length-1;i>=0;i--){ if(collide(pr,enemies[i].rect())){ enemies.splice(i,1); player.health--; if(player.health<=0){ gameOver=true; running=false; btnRestart.style.display='block'; } } } }

      ctx.clearRect(0,0,W,H); particles.forEach(p=>p.draw()); enemies.forEach(e=>e.draw()); bullets.forEach(b=>b.draw()); player.draw();
      hud.innerHTML=`Score: ${score}<br>HP: ${player.health}<br>Car: Ferrari`;
      stageEl.textContent=`Stage: ${STAGES[stageIndex].name}`;
      requestAnimationFrame(loop); }
    requestAnimationFrame(loop);

    btnRestart.addEventListener('click',()=>{ btnRestart.style.display='none'; running=true; reset(); });
    window.addEventListener('keydown', e=>{ if(e.key==='r'||e.key==='R'){ btnRestart.style.display='none'; running=true; reset(); } });
  })();
  </script>
</body>
</html>
